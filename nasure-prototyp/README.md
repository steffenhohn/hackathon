# Nasure Prototyp

**Current Status**: âœ… Event-driven processing with MinIO-first storage

## ğŸ—ï¸ Event-Driven Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API LAYER (FastAPI)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/v1/fhir/ingest                                      â”‚
â”‚  â”œâ”€ Receives CH-eLM FHIR Bundle                               â”‚
â”‚  â”œâ”€ Publishes FHIRBundleReceived event                        â”‚
â”‚  â””â”€ Returns bundle_id for status tracking                      â”‚
â”‚                                                                 â”‚
â”‚  GET /api/v1/status/{bundle_id}                                â”‚
â”‚  GET /api/v1/reports                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EVENT-DRIVEN PROCESSING FLOW                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€ 1. FHIRBundleReceived Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â””â”€ Store raw FHIR bundle in MinIO FIRST (priority)    â”‚  â”‚
â”‚  â”‚       â””â”€ Publishes FHIRBundleStored event               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                â”‚                               â”‚
â”‚                                â–¼                               â”‚
â”‚  â”Œâ”€ 2. FHIRBundleStored Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â””â”€ Triggers data product generation                    â”‚  â”‚
â”‚  â”‚       â””â”€ Publishes DataProductRequested event           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                â”‚                               â”‚
â”‚                                â–¼                               â”‚
â”‚  â”Œâ”€ 3. DataProductRequested Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â”œâ”€ Reads FHIR bundle from MinIO                        â”‚  â”‚
â”‚  â”‚   â”œâ”€ Calls Patient Mapping Service                       â”‚  â”‚
â”‚  â”‚   â”œâ”€ Calls Organization Mapping Service                  â”‚  â”‚
â”‚  â”‚   â”œâ”€ Transforms to surveillance data product             â”‚  â”‚
â”‚  â”‚   â””â”€ Stores in PostgreSQL                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     STORAGE LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ MinIO           â”‚  â”‚ PostgreSQL       â”‚  â”‚ External APIs   â”‚â”‚
â”‚  â”‚ (Raw FHIR)      â”‚  â”‚ (Data Product)   â”‚  â”‚ (Mapping)       â”‚â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                 â”‚â”‚
â”‚  â”‚ â€¢ YYYY/MM/DD/   â”‚  â”‚ â€¢ LaboratoryReportâ”‚  â”‚ â€¢ Patient       â”‚â”‚
â”‚  â”‚   structure     â”‚  â”‚   table          â”‚  â”‚   Mapping API   â”‚â”‚
â”‚  â”‚ â€¢ Immutable     â”‚  â”‚ â€¢ Surveillance   â”‚  â”‚ â€¢ Organization  â”‚â”‚
â”‚  â”‚   storage       â”‚  â”‚   optimized      â”‚  â”‚   Mapping API   â”‚â”‚
â”‚  â”‚ â€¢ Audit trail   â”‚  â”‚ â€¢ Indexing       â”‚  â”‚ â€¢ (Returns      â”‚â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚   random IDs)   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MAPPING SERVICES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Patient Mapping â”‚  â”‚ Organization     â”‚  â”‚ FHIR            â”‚â”‚
â”‚  â”‚ Service         â”‚  â”‚ Mapping Service  â”‚  â”‚ Transformer     â”‚â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                 â”‚â”‚
â”‚  â”‚ AHV Number â†’    â”‚  â”‚ GLN â†’ Anonymous  â”‚  â”‚ LOINC â†’ pathogen â”‚â”‚
â”‚  â”‚ Anonymous ID    â”‚  â”‚ Organization ID  â”‚  â”‚ 697-3 â†’ NG      â”‚â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                 â”‚â”‚
â”‚  â”‚ â€¢ Deterministic â”‚  â”‚ â€¢ Deterministic  â”‚  â”‚ â€¢ CH-eLM v1.10  â”‚â”‚
â”‚  â”‚   UUID from     â”‚  â”‚   UUID from GLN  â”‚  â”‚   Mappings      â”‚â”‚
â”‚  â”‚   AHV SHA256    â”‚  â”‚   SHA256         â”‚  â”‚ â€¢ SNOMED â†’      â”‚â”‚
â”‚  â”‚ â€¢ (Ready for    â”‚  â”‚ â€¢ (Ready for     â”‚  â”‚   Result Type   â”‚â”‚
â”‚  â”‚   external API) â”‚  â”‚   external API)  â”‚  â”‚                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DATA PRODUCT INTERFACE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LaboratoryReport (Minimal Essential Data)                     â”‚
â”‚  â”œâ”€ patient_id: "c4ca4238-a0b9..."        # Anonymous ID     â”‚
â”‚  â”œâ”€ pathogen: "neisseria_gonorrhoeae"     # Primary pathogen â”‚
â”‚  â”œâ”€ performing_lab_id: "a9b8c7d6..."      # Anonymous lab ID â”‚
â”‚  â”œâ”€ ordering_facility_id: "e5f4g3h2..."   # Anonymous fac ID â”‚
â”‚  â”œâ”€ bundle_id: "1Doc-NeisseriaGonorrhoeae"                   â”‚
â”‚  â”œâ”€ fhir_identifier: "urn:uuid:1901332d..."                  â”‚
â”‚  â”œâ”€ report_timestamp: "2023-07-14T16:00:00+02:00"           â”‚
â”‚  â””â”€ observations: [test results with LOINCâ†’pathogen mapping] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Process Flow

```
1. FHIR Bundle Received â†’ MinIO Storage (PRIORITY 1)
   â”œâ”€ Immediate raw data persistence
   â”œâ”€ Immutable audit trail
   â””â”€ Processing can continue from stored state

2. MinIO Storage Complete â†’ Data Product Generation
   â”œâ”€ Asynchronous processing
   â”œâ”€ No data loss if processing fails
   â””â”€ Can replay from stored FHIR

3. Individual Service Calls â†’ Anonymous Mappings
   â”œâ”€ Patient AHV â†’ Anonymous UUID
   â”œâ”€ Organization GLN â†’ Anonymous UUID
   â””â”€ Ready for external API integration

```

## ğŸš€ Getting Started

### Prerequisites

- Docker and Docker Compose
- Python 3.11+

**Start Infrastructure:**

```bash
make up
```

**Run tests**

```bash
make test
```

**Manual API calls**

```bash
# Send FHIR bundle via API
curl -X POST "http://localhost:8000/api/v1/fhir/ingest" \
     -H "Content-Type: application/json" \
     -d @examples/ch_elm_bundles/anthrax_1.json

# Check processing status
curl "http://localhost:8000/api/v1/status/{bundle_id}"



5. **Access Services:**
- **API**: http://localhost:8000 (FastAPI)
- **MinIO Console**: http://localhost:9001 (Raw FHIR storage)


```
